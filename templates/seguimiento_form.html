{% extends 'base.html' %}

{% block title %}Seguimiento Quiropráctico - {{ patient.nombre }} {{ patient.apellidop }}{% endblock %}

{% block head_extra %}
<style>
    /* Estilos para el Zoom de Imágenes (Lightbox) */
    .lightbox-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.9);
        display: flex;
        justify-content: center;
        align-items: center;
        z-index: 9999;
        cursor: pointer;
        padding: 20px;
        box-sizing: border-box;
    }

    .lightbox-image {
        max-width: 95%;
        max-height: 95%;
        object-fit: contain;
        border: 3px solid white;
        box-shadow: 0 0 25px rgba(0, 0, 0, 0.5);
    }

    /* Estilos del Espinograma */
    .spine-container {
        max-width: 140px;
        margin: 0 auto;
    }

    #spineSvg {
        height: auto;
        width: 100%;
    }

    /* Vértebras interactivas */
    .vertebra-path {
        fill: #f0f0f0;
        stroke: #333;
        stroke-width: 1;
        cursor: pointer;
        transition: all 0.3s ease;
    }

    .vertebra-path:hover {
        fill: #d1e7dd;
        transform: scale(1.02);
    }

    .vertebra-path.selected {
        fill: #dc3545;
        stroke: #fff;
    }

    /* Rojo al seleccionar */
    .vertebra-label {
        font-size: 10px;
        pointer-events: none;
        fill: #333;
        font-weight: bold;
    }

    /* Inputs dinámicos */
    .adjustment-input-group {
        transition: all 0.3s ease;
        border-left: 4px solid #198754;
        background-color: #f8f9fa;
        padding: 10px;
        margin-bottom: 10px;
        border-radius: 4px;
    }

    .fade-in {
        animation: fadeIn 0.5s;
    }

    @keyframes fadeIn {
        from {
            opacity: 0;
            transform: translateY(-10px);
        }

        to {
            opacity: 1;
            transform: translateY(0);
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid mt-4">
    <div class="row">

        <div class="col-md-3">
            {% include 'patient-sidebar.html' %}
        </div>

        <div class="col-md-9">
            <div class="card shadow-sm mb-4">

                <div class="card-header d-flex align-items-center justify-content-between">
                    <h5 class="mb-0"><i class="fas fa-walking fa-fw me-2"></i>Seguimiento (Ajuste)</h5>
                    <span>ID Paciente: {{ patient.id_px }}</span>
                </div>

                <form method="post" action="{{ url_for('clinical.manage_seguimiento', patient_id=patient.id_px) }}">
                    <div class="card-body">

                        <input type="hidden" name="id_seguimiento" value="{{ loaded_id_seguimiento or '' }}">
                        <input type="hidden" name="fecha_cargada" value="{{ current_data.get('fecha', today_str ) }}">
                        <input type="hidden" name="id_postura_hoy" value="{{ id_postura_hoy_para_form or '' }}">

                        <div class="alert {% if qp_restantes <= 0 %}alert-danger{% elif qp_restantes <= 2 %}alert-warning{% else %}alert-info{% endif %} mb-3"
                            role="alert">
                            <h5 class="alert-heading" style="font-size: 1.1rem;">
                                <strong>Plan:</strong> {{ active_plan_status.pb_diagnostico or 'Plan Activo' }}
                            </h5>
                            <p class="mb-0">
                                <strong>Ajustes (QP):</strong> <span class="fw-bold fs-5">{{ qp_restantes }}</span>
                                Restantes
                                <small class="text-muted">
                                    {% if loaded_id_seguimiento %}
                                    (Visita <strong>{{ visita_qp_actual }}</strong> de <strong>{{ qp_total }}</strong>)
                                    {% else %}
                                    (Esta será la visita <strong>{{ visita_qp_actual }}</strong> de <strong>{{ qp_total
                                        }}</strong>)
                                    {% endif %}
                                </small>
                            </p>
                            <p class="mb-0">
                                <strong>Terapias (TF):</strong> <span class="fw-bold fs-5">{{ tf_restantes }}</span>
                                Restantes
                                <small class="text-muted">
                                    {% if loaded_id_seguimiento %}
                                    (Visita <strong>{{ visita_tf_actual }}</strong> de <strong>{{ tf_total }}</strong>)
                                    {% else %}
                                    (Esta será la visita <strong>{{ visita_tf_actual }}</strong> de <strong>{{ tf_total
                                        }}</strong>)
                                    {% endif %}
                                </small>
                            </p>
                            {% if qp_restantes <= 0 %} <div class="fw-bold mt-2">¡Atención! Paciente ha completado sus
                                ajustes (QP) de este plan.
                        </div>
                        {% endif %}
                    </div>

                    <div class="row mb-3 align-items-center">
                        <div class="col-md-7">
                            <div class="dropdown">
                                <button class="btn btn-outline-secondary dropdown-toggle btn-sm" type="button"
                                    id="seguimientoHistoryDropdown" data-bs-toggle="dropdown">
                                    Viendo:
                                    {% if loaded_id_seguimiento %}
                                    {% set loaded_record = (all_records_info|selectattr('id_seguimiento', 'equalto',
                                    loaded_id_seguimiento)|first) %}
                                    {% if loaded_record %}{{ loaded_record.fecha }}{% else %}ID {{ loaded_id_seguimiento
                                    }}{% endif %}
                                    {% else %}
                                    Nuevo Registro ({{ today_str }})
                                    {% endif %}
                                </button>
                                <ul class="dropdown-menu">
                                    <li><a class="dropdown-item"
                                            href="{{ url_for('clinical.manage_seguimiento', patient_id=patient.id_px) }}">+
                                            Crear Nuevo</a></li>
                                    <li>
                                        <hr class="dropdown-divider">
                                    </li>
                                    {% for record in all_records_info %}
                                    <li><a class="dropdown-item"
                                            href="{{ url_for('clinical.manage_seguimiento', patient_id=patient.id_px, selected_id=record.id_seguimiento) }}">{{
                                            record.fecha }}</a></li>
                                    {% endfor %}
                                </ul>
                            </div>
                        </div>
                        <div class="col-md-5 text-md-end">
                            <p class="text-muted mb-0"><small><strong>Atendiendo:</strong> Dr. {{ nombre_doctor_sesion
                                    or 'N/A' }}</small></p>
                            <small><strong>Fecha:</strong> {{ current_data.get('fecha') or today_str }}</small>
                        </div>
                    </div>

                    <div class="form-section mb-3">
                        <h5>Asociar a Plan de Cuidado</h5>
                        <select class="form-select form-select-sm" name="id_plan_cuidado_asociado" {% if not is_editable
                            %}disabled{% endif %}>
                            <option value="">-- No asociar / Visita fuera de plan --</option>
                            {% if active_plans_list %}
                            {% for plan in active_plans_list %}
                            <option value="{{ plan.id_plan }}" {% if plan.id_plan==id_plan_asociado_seleccionado
                                %}selected{% endif %}>
                                {{ plan.fecha }} - {{ plan.pb_diagnostico|truncate(40) }} (QP: {{plan.visitas_qp}})
                            </option>
                            {% endfor %}
                            {% endif %}
                        </select>
                    </div>

                    {% if show_ortho_notes_field %}
                    <div class="mb-3">
                        <label for="notas_pruebas_ortoneuro" class="form-label fw-bold">Notas de Pruebas Ortopédicas (de
                            hoy)</label>
                        <textarea class="form-control" id="notas_pruebas_ortoneuro" name="notas_pruebas_ortoneuro"
                            rows="3" placeholder="Estas notas se guardarán en el registro de Pruebas de hoy..." {% if
                            not is_editable %}disabled{% endif %}>{{ ortho_notes_today or '' }}</textarea>
                    </div>
                    {% endif %}

                    <hr>

                    <div class="row">

                        <div class="col-md-4 d-flex justify-content-center align-items-start">
                            <div class="spine-container sticky-top" style="top: 20px; z-index: 1;">
                                <h6 class="text-center text-muted mb-2 small">Ajustes Realizados</h6>

                                <svg viewBox="0 0 100 650" xmlns="http://www.w3.org/2000/svg" id="spineSvg">
                                    <g class="vertebra-group" data-target="occipital">
                                        <rect x="20" y="10" width="60" height="20" rx="5" class="vertebra-path" /><text
                                            x="50" y="24" text-anchor="middle" class="vertebra-label">OCC</text>
                                    </g>
                                    <g class="vertebra-group" data-target="atlas">
                                        <rect x="25" y="35" width="50" height="15" rx="3" class="vertebra-path" /><text
                                            x="50" y="46" text-anchor="middle" class="vertebra-label">C1</text>
                                    </g>
                                    <g class="vertebra-group" data-target="axis">
                                        <rect x="25" y="55" width="50" height="15" rx="3" class="vertebra-path" /><text
                                            x="50" y="66" text-anchor="middle" class="vertebra-label">C2</text>
                                    </g>
                                    <g class="vertebra-group" data-target="c3">
                                        <rect x="28" y="75" width="44" height="15" rx="3" class="vertebra-path" /><text
                                            x="50" y="86" text-anchor="middle" class="vertebra-label">C3</text>
                                    </g>
                                    <g class="vertebra-group" data-target="c4">
                                        <rect x="28" y="95" width="44" height="15" rx="3" class="vertebra-path" /><text
                                            x="50" y="106" text-anchor="middle" class="vertebra-label">C4</text>
                                    </g>
                                    <g class="vertebra-group" data-target="c5">
                                        <rect x="28" y="115" width="44" height="15" rx="3" class="vertebra-path" /><text
                                            x="50" y="126" text-anchor="middle" class="vertebra-label">C5</text>
                                    </g>
                                    <g class="vertebra-group" data-target="c6">
                                        <rect x="28" y="135" width="44" height="15" rx="3" class="vertebra-path" /><text
                                            x="50" y="146" text-anchor="middle" class="vertebra-label">C6</text>
                                    </g>
                                    <g class="vertebra-group" data-target="c7">
                                        <rect x="25" y="155" width="50" height="18" rx="3" class="vertebra-path" /><text
                                            x="50" y="168" text-anchor="middle" class="vertebra-label">C7</text>
                                    </g>
                                    <g class="vertebra-group" data-target="t1">
                                        <rect x="20" y="180" width="60" height="18" rx="2" class="vertebra-path" /><text
                                            x="50" y="193" text-anchor="middle" class="vertebra-label">T1</text>
                                    </g>
                                    <g class="vertebra-group" data-target="t2">
                                        <rect x="20" y="200" width="60" height="18" rx="2" class="vertebra-path" /><text
                                            x="50" y="213" text-anchor="middle" class="vertebra-label">T2</text>
                                    </g>
                                    <g class="vertebra-group" data-target="t3">
                                        <rect x="20" y="220" width="60" height="18" rx="2" class="vertebra-path" /><text
                                            x="50" y="233" text-anchor="middle" class="vertebra-label">T3</text>
                                    </g>
                                    <g class="vertebra-group" data-target="t4">
                                        <rect x="20" y="240" width="60" height="18" rx="2" class="vertebra-path" /><text
                                            x="50" y="253" text-anchor="middle" class="vertebra-label">T4</text>
                                    </g>
                                    <g class="vertebra-group" data-target="t5">
                                        <rect x="20" y="260" width="60" height="18" rx="2" class="vertebra-path" /><text
                                            x="50" y="273" text-anchor="middle" class="vertebra-label">T5</text>
                                    </g>
                                    <g class="vertebra-group" data-target="t6">
                                        <rect x="20" y="280" width="60" height="18" rx="2" class="vertebra-path" /><text
                                            x="50" y="293" text-anchor="middle" class="vertebra-label">T6</text>
                                    </g>
                                    <g class="vertebra-group" data-target="t7">
                                        <rect x="20" y="300" width="60" height="18" rx="2" class="vertebra-path" /><text
                                            x="50" y="313" text-anchor="middle" class="vertebra-label">T7</text>
                                    </g>
                                    <g class="vertebra-group" data-target="t8">
                                        <rect x="20" y="320" width="60" height="18" rx="2" class="vertebra-path" /><text
                                            x="50" y="333" text-anchor="middle" class="vertebra-label">T8</text>
                                    </g>
                                    <g class="vertebra-group" data-target="t9">
                                        <rect x="20" y="340" width="60" height="18" rx="2" class="vertebra-path" /><text
                                            x="50" y="353" text-anchor="middle" class="vertebra-label">T9</text>
                                    </g>
                                    <g class="vertebra-group" data-target="t10">
                                        <rect x="20" y="360" width="60" height="18" rx="2" class="vertebra-path" /><text
                                            x="50" y="373" text-anchor="middle" class="vertebra-label">T10</text>
                                    </g>
                                    <g class="vertebra-group" data-target="t11">
                                        <rect x="20" y="380" width="60" height="18" rx="2" class="vertebra-path" /><text
                                            x="50" y="393" text-anchor="middle" class="vertebra-label">T11</text>
                                    </g>
                                    <g class="vertebra-group" data-target="t12">
                                        <rect x="20" y="400" width="60" height="18" rx="2" class="vertebra-path" /><text
                                            x="50" y="413" text-anchor="middle" class="vertebra-label">T12</text>
                                    </g>
                                    <g class="vertebra-group" data-target="l1">
                                        <rect x="15" y="430" width="70" height="20" rx="4" class="vertebra-path" /><text
                                            x="50" y="444" text-anchor="middle" class="vertebra-label">L1</text>
                                    </g>
                                    <g class="vertebra-group" data-target="l2">
                                        <rect x="15" y="455" width="70" height="20" rx="4" class="vertebra-path" /><text
                                            x="50" y="469" text-anchor="middle" class="vertebra-label">L2</text>
                                    </g>
                                    <g class="vertebra-group" data-target="l3">
                                        <rect x="15" y="480" width="70" height="20" rx="4" class="vertebra-path" /><text
                                            x="50" y="494" text-anchor="middle" class="vertebra-label">L3</text>
                                    </g>
                                    <g class="vertebra-group" data-target="l4">
                                        <rect x="15" y="505" width="70" height="20" rx="4" class="vertebra-path" /><text
                                            x="50" y="519" text-anchor="middle" class="vertebra-label">L4</text>
                                    </g>
                                    <g class="vertebra-group" data-target="l5">
                                        <rect x="15" y="530" width="70" height="20" rx="4" class="vertebra-path" /><text
                                            x="50" y="544" text-anchor="middle" class="vertebra-label">L5</text>
                                    </g>
                                    <g class="vertebra-group" data-target="sacro">
                                        <path d="M 25 560 L 75 560 L 50 610 Z" class="vertebra-path" /><text x="50"
                                            y="580" text-anchor="middle" class="vertebra-label" fill="white">SAC</text>
                                    </g>
                                    <g class="vertebra-group" data-target="iliaco_i">
                                        <path d="M 10 560 Q 0 580 20 600" class="vertebra-path" fill="none" /><text
                                            x="10" y="580" text-anchor="middle" class="vertebra-label">IL-I</text>
                                    </g>
                                    <g class="vertebra-group" data-target="iliaco_d">
                                        <path d="M 90 560 Q 100 580 80 600" class="vertebra-path" fill="none" /><text
                                            x="90" y="580" text-anchor="middle" class="vertebra-label">IL-D</text>
                                    </g>
                                    <g class="vertebra-group" data-target="pubis">
                                        <rect x="40" y="620" width="20" height="10" rx="2" class="vertebra-path" /><text
                                            x="50" y="629" text-anchor="middle" class="vertebra-label">PUB</text>
                                    </g>
                                </svg>
                            </div>
                        </div>

                        <div class="col-md-8">

                            <div class="card shadow-sm mb-3">
                                <div class="card-header bg-white">
                                    <h6 class="mb-0 text-primary fw-bold"><i class="fas fa-list-check"></i> Detalles del
                                        Ajuste</h6>
                                </div>
                                <div class="card-body" id="adjustmentsPanel">
                                    <p class="text-muted text-center small fst-italic" id="emptyStateMsg">
                                        Selecciona segmentos en el espinograma para añadir notas.
                                    </p>

                                    {% set segmentos = [
                                    'occipital', 'atlas', 'axis', 'c3', 'c4', 'c5', 'c6', 'c7',
                                    't1', 't2', 't3', 't4', 't5', 't6', 't7', 't8', 't9', 't10', 't11', 't12',
                                    'l1', 'l2', 'l3', 'l4', 'l5', 'sacro', 'coxis', 'iliaco_d', 'iliaco_i', 'pubis'
                                    ] %}

                                    {% for seg in segmentos %}
                                    {% set valor_actual = current_data.get(seg, '') if current_data else '' %}
                                    <div id="container_{{ seg }}"
                                        class="adjustment-input-group fade-in {% if not valor_actual %}d-none{% endif %}">
                                        <div class="d-flex justify-content-between align-items-center mb-1">
                                            <label for="input_{{ seg }}" class="fw-bold text-dark mb-0">{{ seg|upper
                                                }}</label>
                                            <button type="button" class="btn btn-sm btn-outline-danger border-0"
                                                onclick="removeSegment('{{ seg }}')">
                                                <i class="fas fa-times"></i>
                                            </button>
                                        </div>
                                        <input type="text" id="input_{{ seg }}" name="{{ seg }}"
                                            value="{{ valor_actual }}" class="form-control form-control-sm spine-input"
                                            placeholder="Escribe listing/técnica...">
                                    </div>
                                    {% endfor %}
                                </div>
                            </div>

                            <div class="card shadow-sm mb-3">
                                <div class="card-header bg-white text-success fw-bold">Terapia Física Aplicada</div>
                                <div class="card-body">
                                    {% if available_therapies %}
                                    <div class="row">
                                        {% for terapia in available_therapies %}
                                        <div class="col-6">
                                            <div class="form-check">
                                                <input class="form-check-input" type="checkbox" name="terapia_chk"
                                                    value="{{ terapia.id_prod }}" id="terapia_{{ terapia.id_prod }}" {%
                                                    if current_selected_ids and terapia.id_prod|string in
                                                    current_selected_ids %}checked{% endif %}>
                                                <label class="form-check-label small"
                                                    for="terapia_{{ terapia.id_prod }}">
                                                    {{ terapia.nombre }}
                                                </label>
                                            </div>
                                        </div>
                                        {% endfor %}
                                    </div>
                                    {% else %}
                                    <p class="text-muted small">No hay terapias registradas.</p>
                                    {% endif %}
                                </div>
                            </div>

                            <div class="card shadow-sm mb-3">
                                <div class="card-header bg-white fw-bold">Notas de la Visita</div>
                                <div class="card-body p-2">
                                    <textarea name="notas" class="form-control" rows="3"
                                        placeholder="Añada notas de esta visita aqui...">{{ current_data.get('notas', '') if current_data else '' }}</textarea>
                                </div>
                            </div>

                        </div>
                    </div>
                    <hr class="my-4">

                    <div class="row">
                        <div class="col-12">
                            <div class="card shadow-sm border-light">
                                <div class="card-header bg-light">
                                    <strong>Historia Narrativa</strong> <small class="text-muted">(Última
                                        Anamnesis)</small>
                                </div>
                                <div class="card-body" style="max-height: 200px; overflow-y: auto;">
                                    <p class="card-text text-muted" style="white-space: pre-wrap;">{{ historia_narrativa
                                        or 'No disponible.' }}</p>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="row g-4 mt-1">
                        <div class="col-12">
                            <div class="form-section p-3 border rounded bg-white">
                                <h5 class="mb-3">Últimas Pruebas Visuales Registradas (Referencia)</h5>

                                {% if latest_postura_data and latest_postura_data.id_postura %}
                                <p><small class="text-muted">Fotos de la visita del: {{ latest_postura_data.fecha
                                        }}</small></p>
                                <div class="row text-center g-2 mb-3">
                                    {% set postura_images = [
                                    ('frente', 'Frontal', latest_postura_data.get('frente')),
                                    ('lado', 'Lateral', latest_postura_data.get('lado')),
                                    ('postura_extra', 'Extra', latest_postura_data.get('postura_extra')),
                                    ('pies', 'Pisada', latest_postura_data.get('pies')),
                                    ('termografia', 'Termo', latest_postura_data.get('termografia'))
                                    ] %}

                                    {% for key, label, path in postura_images %}
                                    {% if path %}
                                    <div class="col-6 col-sm-4 col-md-2">
                                        <img src="{{ url_for('static', filename=path) }}" alt="{{ label }}"
                                            class="img-thumbnail zoomable-image"
                                            style="height: 80px; width: auto; object-fit: contain; cursor: pointer;"
                                            title="Ver {{ label }}">
                                        <p class="mt-1 mb-0"><small>{{ label }}</small></p>
                                    </div>
                                    {% endif %}
                                    {% endfor %}
                                </div>
                                {% else %}
                                <p class="text-muted small">Aún no se han registrado fotos de pruebas.</p>
                                {% endif %}

                                <hr class="my-3">

                                <h6>Radiografías Recientes</h6>
                                {% if latest_rx_list %}
                                <div class="row text-center g-2">
                                    {% for rx in latest_rx_list %}
                                    <div class="col-6 col-sm-4 col-md-2">
                                        <img src="{{ url_for('static', filename=rx.ruta_archivo) }}"
                                            alt="Rx {{ loop.index }}" class="img-thumbnail zoomable-image"
                                            style="height: 80px; width: auto; object-fit: contain; cursor: pointer;"
                                            title="Ver Rx">
                                        <p class="mt-1 mb-0"><small>Del: {{ rx.fecha_visita_asociada }}</small></p>
                                    </div>
                                    {% endfor %}
                                </div>
                                {% else %}
                                <p class="text-muted small">No hay radiografías registradas.</p>
                                {% endif %}
                            </div>
                        </div>
                    </div>

                    <div class="d-flex justify-content-end mt-4 border-top pt-3">
                        <a href="{{ url_for('patient.patient_detail', patient_id=patient.id_px) }}"
                            class="btn btn-secondary me-2">Cancelar</a>
                        <button type="submit" class="btn btn-primary" {% if not is_editable %}disabled{% endif
                            %}>Guardar Seguimiento</button>
                    </div>

            </div>
            </form>
        </div>
    </div>
</div>
</div>
{% endblock %}

{% block scripts %}
{{ super() }}
<script>
    document.addEventListener('DOMContentLoaded', function () {
        // --- 1. ZOOM DE IMÁGENES ---
        enableImageZoom();
        function enableImageZoom() {
            const images = document.querySelectorAll('.zoomable-image');
            images.forEach(img => {
                img.addEventListener('click', handleImageClick);
            });
        }
        function handleImageClick(event) {
            const clickedImage = event.target;
            const overlay = document.createElement('div');
            overlay.className = 'lightbox-overlay';
            const largeImage = document.createElement('img');
            largeImage.className = 'lightbox-image';
            largeImage.src = clickedImage.src;
            overlay.appendChild(largeImage);
            document.body.appendChild(overlay);
            overlay.addEventListener('click', () => {
                document.body.removeChild(overlay);
            }, { once: true });
        }

        // --- 2. LÓGICA DEL ESPINOGRAMA ---
        const vertebraGroups = document.querySelectorAll('.vertebra-group');
        const emptyStateMsg = document.getElementById('emptyStateMsg');

        function updateEmptyState() {
            const anyVisible = document.querySelectorAll('.adjustment-input-group:not(.d-none)').length > 0;
            if (anyVisible) {
                emptyStateMsg.classList.add('d-none');
            } else {
                emptyStateMsg.classList.remove('d-none');
            }
        }

        vertebraGroups.forEach(group => {
            const targetName = group.getAttribute('data-target');
            const container = document.getElementById('container_' + targetName);
            const input = document.getElementById('input_' + targetName);
            const path = group.querySelector('.vertebra-path');

            // Cargar estado inicial
            if (input && input.value.trim() !== '') {
                path.classList.add('selected');
            }

            // Click Handler
            group.addEventListener('click', function () {
                path.classList.toggle('selected');
                const isSelected = path.classList.contains('selected');

                if (isSelected) {
                    container.classList.remove('d-none');
                    updateEmptyState();
                    setTimeout(() => input.focus(), 100);
                } else {
                    container.classList.add('d-none');
                    input.value = '';
                    updateEmptyState();
                }
            });
        });

        // Verificar estado inicial al cargar
        updateEmptyState();
    });

    // --- 3. FUNCIÓN PARA QUITAR SEGMENTO DESDE EL PANEL ---
    function removeSegment(segName) {
        const container = document.getElementById('container_' + segName);
        const input = document.getElementById('input_' + segName);
        const group = document.querySelector(`.vertebra-group[data-target="${segName}"]`);
        const path = group ? group.querySelector('.vertebra-path') : null;

        if (container) container.classList.add('d-none');
        if (input) input.value = '';
        if (path) path.classList.remove('selected');

        // Necesitamos acceder a la función updateEmptyState, o replicar su lógica
        const emptyStateMsg = document.getElementById('emptyStateMsg');
        const anyVisible = document.querySelectorAll('.adjustment-input-group:not(.d-none)').length > 0;
        if (!anyVisible) emptyStateMsg.classList.remove('d-none');
    }
</script>
{% endblock %}